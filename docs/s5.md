#### 5.33

The basic Diffie-Hellman algorithm for key exchange between Alice and
Bob goes as follows. Alice and Bob agree on a finite cyclic group of
some particular order to use. They each randomly and independently pick
some number of times to perform the group operation (which must be
greater than zero, and less than the order of the group) and perform the
group operation on the generator that number of times, publishing their
results. For generator g, Alice's number x, and Bob's number y: Alice
publishes g ^ x, and Bob publishes g ^ y.

Each then performs his or her own secret number of additional group
operations on the other's public result, establishing the key g ^ xy.
Since the discrete logarithm problem is hard, an eavesdropper can't (for
an appropriate group) determine how many times either has performed the
individual group operations, even given g; he can only naïvely calculate
g ^ (x + y).

For the initial illustration here we're using a decidedly insecure
group, i.e. the multiplicative group of 16-bit words modulo 37:

    > gen <- MWC.create
    > let p = 37
    > let g = 5
    > a <- fmap (`mod` p) (MWC.uniformR (1, p - 1) gen) :: IO Word16
    > b <- fmap (`mod` p) (MWC.uniformR (1, p - 1) gen) :: IO Word16
    > let bigA = g ^ a `mod` p
    > let bigB = g ^ b `mod` p
    > let s = bigB ^ a `mod` p
    > let t = bigA ^ b `mod` p
    > s == t
    True
    > let k = S.sha1 . BP.runPut $ BP.putWord16be s
    > k
    ace6f761db204030c1a65c0930bd01fd55ecc429

For the big guns, we can pull out GHC's Natural type, for which
mwc-random (our preferred random library) can generate something in a
range. First a modular exponentiation routine:

    -- modified from https://gist.github.com/trevordixon/6788535
    modexp :: Natural -> Natural -> Natural -> Natural
    modexp b e m
      | e == 0    = 1
      | otherwise =
          let t = if B.testBit e 0 then b `mod` m else 1
          in  t * modexp ((b * b) `mod` m) (B.shiftR e 1) m `mod` m

and given that (and appropriate p, g), the key exchange:

    > gen <- MWC.create
    > a <- fmap (`mod` p) (MWC.uniformRM (1, p - 1) gen)
    > b <- fmap (`mod` p) (MWC.uniformRM (1, p - 1) gen)
    > let bigA = modexp g a p
    > let bigB = modexp g b p
    > let s = modexp bigB a p
    > let t = modexp bigA b p
    > s == t
    True

That's all well and good, but let's have a bit of fun.

Cryptopals.DH implements the Diffie-Hellman protocol over TCP. Two
functions, 'bob' and 'alice', will initiate a TCP server and client,
respectively. Each takes as argument a port to bind to and a protocol to
follow, with Alice also taking an argument specifying the initial action
she'll take. The two will then perform the specified protocol.

The 'dh' protocol specifies Diffie-Hellman, and for the lulz Alice and
Bob will exchange a message, AES128-encrypted with the shared key, à la
the initial illustration in the next challenge.

Opening two instances of GHCi, we can run e.g.:

  > bob "3000" dh

in one, and:

  > alice "3000" dh

in the other and watch the logs for fun. Here I'll interleave the
relevant parts of the logs for readability:

    (cryptopals) bob: listening..
    (cryptopals) alice: session established
    (cryptopals) alice: sending group parameters and public key
    (cryptopals) bob: received group parameters and public key
    (cryptopals) bob: sending public key
    (cryptopals) alice: received public key
    (cryptopals) alice: sending ciphertext fQwcd2smXxBojyEDLrIdySNLAV3UHhl8/X2F/x4FIb0=
    (cryptopals) bob: received ciphertext fQwcd2smXxBojyEDLrIdySNLAV3UHhl8/X2F/x4FIb0=
    (cryptopals) bob: decrypted ciphertext: "attack at 10pm"
    (cryptopals) bob: replying with ciphertext NaObgnz4rNShMKRGdGv+OGnI2gZnWOoXuYmCZhlcyymRbHPaprFVOz4Ls5eH9y/W
    (cryptopals) alice: received ciphertext NaObgnz4rNShMKRGdGv+OGnI2gZnWOoXuYmCZhlcyymRbHPaprFVOz4Ls5eH9y/W
    (cryptopals) alice: decrypted ciphertext: "confirmed, attacking at 10pm"
    (cryptopals) bob: ending session

#### 5.34

If B = p in s = B ^ a mod p, then s = p ^ a mod p, which is zero for any
'a' in the group. Our shared key is thus going to be the first 16 bytes
of the SHA1 hash of an appropriately-serialized 0x00.

Cryptopals.DH includes a 'mallory' agent that requires a port to listen
on, a port to bind to, and a protocol to follow. By using the 'dhmitm'
protocol, we get our man-in-the-middle attack on Alice and Bob's DH key
exchange.

You can get this going by opening three GHCi's, then launching e.g.:

    > bob "3000" dh

in one, then:

    > mallory "3001" "3000" dhmitm

in another, and finally:

    > alice "3001" dh sendParams

in the third. Again, I'm interleaving the logs for readability:

    (cryptopals) bob: listening..
    (cryptopals) mallory: LiSteNIng..
    (cryptopals) alice: session established
    (cryptopals) mallory: eStabLisHed coNNecTion
    (cryptopals) alice: sending group parameters and public key
    (cryptopals) mallory: reCEiVed GRoUp pArAmeTErs And pUBliC kEy
    (cryptopals) mallory: sEnDinG BOguS paRaMeTeRs
    (cryptopals) bob: received group parameters and public key
    (cryptopals) bob: sending public key
    (cryptopals) mallory: REceIvED pUBlic keY
    (cryptopals) mallory: seNDINg boGus kEy
    (cryptopals) alice: received public key
    (cryptopals) alice: sending ciphertext tM4Y5fpafrsf9+A4UB5UaudkAVzwMtjsjDIwShPKHcU=
    (cryptopals) mallory: rECeIveD CiPHeRTexT tM4Y5fpafrsf9+A4UB5UaudkAVzwMtjsjDIwShPKHcU=
    (cryptopals) mallory: DEcRyptEd cIPheRTeXt: "attack at 10pm"
    (cryptopals) mallory: reLayINg cIpheRtExt
    (cryptopals) bob: received ciphertext tM4Y5fpafrsf9+A4UB5UaudkAVzwMtjsjDIwShPKHcU=
    (cryptopals) bob: decrypted ciphertext: "attack at 10pm"
    (cryptopals) bob: replying with ciphertext ux4PoPTCS7pz5H4IQ11AuZkMBHmEcT9Waz68y/a9nggIY38Z6mbwSrCwNO3OKcDQ
    (cryptopals) mallory: reCeiVeD CipHeRtExt ux4PoPTCS7pz5H4IQ11AuZkMBHmEcT9Waz68y/a9nggIY38Z6mbwSrCwNO3OKcDQ
    (cryptopals) mallory: DeCrYpteD cIphErteXt: "confirmed, attacking at 10pm"
    (cryptopals) mallory: ReLaYINg CiPHeRTexT
    (cryptopals) alice: received ciphertext ux4PoPTCS7pz5H4IQ11AuZkMBHmEcT9Waz68y/a9nggIY38Z6mbwSrCwNO3OKcDQ
    (cryptopals) alice: decrypted ciphertext: "confirmed, attacking at 10pm"

#### 5.35

Cryptopals.DH.dhng implements the negotiated-groups DH protocol, so that
can be run by firing off e.g.:

    > bob "3000" dhng

in one GHCi session, and:

    > alice "3000" dhng sendGroup

in the other. In the meantime, we can figure out the outcomes of using
the different malicious group parameters analytically.

For g = 1, the MITM attack starts as follows:

    alice sends      p, g
    bob gets         p, 1

If Bob receives g = 1, then Mallory knows his public key will equal 1 ^
b mod p = 1, as will the shared key from Alice's perspective (since 1 ^
a mod p = 1). Mallory thus needs to forward a 1 as Alice's public key in
order for Bob to agree on the shared key.

For g = p, Bob computes B = p ^ b mod p = 0, so Mallory needs to forward
a 0 as Alice's public key in order for them to agree on the shared key.

Finally, the case of g = p - 1. Note that for any p > 1 and any even b, we
have (for appropriate coefficients a, c, etc.):

    (p - 1) ^ b mod p
      = (p^b + .. + ap^2 + cp + 1) mod p
      = (p^b mod p + .. + ap^2 mod p + cp mod p + 1 mod p) mod p
      = (0 + .. + 0 + 1 mod p) mod p
      = 1

whereas for any odd b, we have:

    (p - 1) ^ b mod p
      = (p^b - .. - cp^2 + dp - 1) mod p
      = (p^b mod p - .. - ap^2 mod p + cp mod p - 1 mod p) mod p
      = (0 + .. + 0 - 1 mod p) mod p
      = p - 1.

So Bob's public key will be either 1 or p - 1 depending on whether his
secret key is even or odd. Alice will thus compute:

    s = B ^ a mod p
      = 1               } b even or a even
        p - 1           } b odd and a odd.

If Mallory thus forwards A = 1 to Bob, we have:

    t = A ^ b mod p
      = 1.

So, Alice and Bob will agree on the key 1 (i.e., the attack succeeds)
whenever 'b' is even or 'a' is even, an event that occurs with
probability 1/2 + 1/2 - 1/4 = 3/4.

(Mallory could ensure the attack works every time by forwarding 1's for
*both* public keys, but that seems against the spirit of the question.)

Here are the interleaved logs of a successful attack:

    (cryptopals) bob: listening..
    (cryptopals) mallory: LiSteNIng..
    (cryptopals) alice: session established
    (cryptopals) mallory: eStabLisHed MiTm coNNecTion
    (cryptopals) alice: sending group parameters
    (cryptopals) mallory: reCEiVed GRoUp pArAmeTErs
    (cryptopals) mallory: sEnDinG BOguS GRoUp paRaMeTeRs
    (cryptopals) bob: received group parameters
    (cryptopals) bob: acking group parameters
    (cryptopals) mallory: rECeiVed aCK
    (cryptopals) mallory: ReLaYINg ACk
    (cryptopals) alice: received ack
    (cryptopals) alice: sending public key 3f44f49421cbb3b2ed40aa8f068236affba15335
    (cryptopals) mallory: REceIvED pUBlic keY 3f44f49421cbb3b2ed40aa8f068236affba15335
    (cryptopals) mallory: SeNDing BoGuS kEy d14952314d5de233ef0dd0a178617f7f07ea082c
    (cryptopals) bob: received public key d14952314d5de233ef0dd0a178617f7f07ea082c
    (cryptopals) bob: sending public key
    (cryptopals) mallory: REceIvED pUBlic keY d14952314d5de233ef0dd0a178617f7f07ea082c
    (cryptopals) mallory: ReLAyINg pUbliC KeY d14952314d5de233ef0dd0a178617f7f07ea082c
    (cryptopals) alice: received public key d14952314d5de233ef0dd0a178617f7f07ea082c
    (cryptopals) alice: sending ciphertext +nbU0t3nLX3WmKoY3+pdmilVcd2I6fJfGuC3RTn0h5E=
    (cryptopals) mallory: rECeIveD CiPHeRTexT +nbU0t3nLX3WmKoY3+pdmilVcd2I6fJfGuC3RTn0h5E=
    (cryptopals) mallory: DEcRyptEd cIPheRTeXt: "attack at 10pm"
    (cryptopals) mallory: reLayINg cIpheRtExt
    (cryptopals) bob: received ciphertext +nbU0t3nLX3WmKoY3+pdmilVcd2I6fJfGuC3RTn0h5E=
    (cryptopals) bob: decrypted ciphertext: "attack at 10pm"
    (cryptopals) bob: replying with ciphertext 3i7fLAZXJv7+cr3qrI8KDKhfe6FpJq62yVtaCt9dlrUodMiRVtJ7ZmKtJ8ku0r4x
    (cryptopals) mallory: reCeiVeD CipHeRtExt 3i7fLAZXJv7+cr3qrI8KDKhfe6FpJq62yVtaCt9dlrUodMiRVtJ7ZmKtJ8ku0r4x
    (cryptopals) mallory: DeCrYpteD cIphErteXt: "confirmed, attacking at 10pm"
    (cryptopals) mallory: ReLaYINg CiPHeRTexT
    (cryptopals) alice: received ciphertext 3i7fLAZXJv7+cr3qrI8KDKhfe6FpJq62yVtaCt9dlrUodMiRVtJ7ZmKtJ8ku0r4x
    (cryptopals) alice: decrypted ciphertext: "confirmed, attacking at 10pm"
    (cryptopals) mallory: ending session



